<div>
  <form class="flex flex-col gap-5" [formGroup]="form" (ngSubmit)="submit()">

    @for (group of groupedMetadata; track group.metadata_group_id) {
      <div class="flex flex-col justify-between rounded-lg cursor-pointer">
        <div class="flex justify-between bg-gray-300 dark:bg-gray-800 px-4 py-2 rounded-t-xl" [ngClass]="{'rounded-b-xl': !group.expanded}" (click)="toggleGroup(group)">
          <h2 class="font-semibold text-gray-800 dark:text-gray-200">
            {{ group.name }}
          </h2>

          <i
            class="fas text-gray-800 dark:text-gray-200"
            [ngClass]="{
              'fa-chevron-down': group.expanded,
              'fa-chevron-right': !group.expanded
            }"
            style="display: flex; justify-content:center;align-items:center"
          ></i>
        </div>
        @if (group.expanded) {
          <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 p-4 bg-gray-100 dark:bg-gray-700 rounded-b-xl">
            @for (metadata of group.items; track metadata.metadata_registry_id) {
              <div class="space-y-2">
                <!-- Label -->
                <label class="text-sm font-medium text-gray-700 dark:text-gray-200">
                  {{ metadata.title }}
                  @if (metadata.isrequired) {
                    <span class="text-red-500">*</span>
                  }
                </label>

                <!-- MULTIPLE -->
                @if (metadata.ismultiple) {
                  @if (getFormArray(metadata.metadata_registry_id); as formArray) {
                  <div [formArrayName]="metadata.metadata_registry_id" class="space-y-3">
                      @for (ctrl of formArray.controls; track $index; let i = $index, let last = $last) {
                      <div class="flex items-start gap-2 w-full">
                        @switch (metadata.componentType?.name?.toLowerCase()) {
                          @case ('text') {
                            <!-- <P>{{form.get(metadata.metadata_registry_id.toString())?.invalid}}---{{
                                  form.get(metadata.metadata_registry_id.toString())?.touched}}</P> -->
                            <input
                              type="text"
                              [formControlName]="i"
                              placeholder="Enter {{ metadata.title }}"
                              [ngClass]="{
                                  'border-red-500': ctrl.invalid && ctrl.touched,
                                  'border-gray-300': !(ctrl.invalid && ctrl.touched)
                                }"
                              class="flex-1 rounded-lg border bg-transparent py-2.5 px-4 text-sm dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"
                            />
                          }

                          @case ('number') {
                            <input
                              type="number"
                              min="1"
                              [formControlName]="i"
                              placeholder="Enter {{ metadata.title }}"
                              [ngClass]="{
                                'border-red-500':
                                  form.get(metadata.metadata_registry_id.toString())?.invalid &&
                                  form.get(metadata.metadata_registry_id.toString())?.touched,
                                'border-gray-300':
                                  !(form.get(metadata.metadata_registry_id.toString())?.invalid &&
                                    form.get(metadata.metadata_registry_id.toString())?.touched)
                              }"
                              class="flex-1 rounded-lg border bg-transparent py-2.5 px-4 text-sm dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"
                            />
                          }

                          @case ('dropdown') {
                            <select
                              [formControlName]="i"
                              [ngClass]="{
                                'border-red-500':
                                  form.get(metadata.metadata_registry_id.toString())?.invalid &&
                                  form.get(metadata.metadata_registry_id.toString())?.touched,
                                'border-gray-300':
                                  !(form.get(metadata.metadata_registry_id.toString())?.invalid &&
                                    form.get(metadata.metadata_registry_id.toString())?.touched)
                              }"
                              class="h-11 w-full flex-1 appearance-none rounded-lg border bg-transparent
                                    px-4 py-2.5 pr-11 text-sm shadow-theme-xs
                                    border-gray-300 focus:border-brand-300 focus:outline-hidden
                                    focus:ring-3 focus:ring-brand-500/10
                                    dark:border-gray-700 dark:bg-gray-900 dark:text-white/90">

                              <option [ngValue]="null">
                                Select {{ metadata.title }}
                              </option>

                              @for (option of getOptionsFromId(metadata.dropdown?.dropdown_id); track $index) {
                                <option [ngValue]="option.value">
                                  {{ option.label }}
                                </option>
                              }
                            </select>
                          }
                          @case ('date') {
                            <!-- <input
                              type="text"
                              [formControlName]="metadata.metadata_registry_id"
                              placeholder="DD-MM-YYYY"
                              [ngClass]="{
                                'border-red-500':
                                  form.get(metadata.metadata_registry_id.toString())?.invalid &&
                                  form.get(metadata.metadata_registry_id.toString())?.touched,
                                'border-gray-300':
                                  !(form.get(metadata.metadata_registry_id.toString())?.invalid &&
                                    form.get(metadata.metadata_registry_id.toString())?.touched)
                              }"
                              class="w-full rounded-lg border bg-transparent py-2.5 px-4 text-sm dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"
                              (input)="formatDateInput($event, metadata.metadata_registry_id.toString())"
                            /> -->

                            <app-date-picker
                              id="date-picker-multiple"
                              placeholder="Select a date"
                              (dateChange)="handleDateChange($event,metadata.metadata_registry_id)"
                              class="w-full rounded-lg bg-transparent text-sm dark:bg-gray-900 dark:text-white/90"
                              [ngClass]="{
                                'border-red-500':
                                  form.get(metadata.metadata_registry_id.toString())?.invalid &&
                                  form.get(metadata.metadata_registry_id.toString())?.touched,
                                'border-gray-300':
                                  !(form.get(metadata.metadata_registry_id.toString())?.invalid &&
                                    form.get(metadata.metadata_registry_id.toString())?.touched)
                              }"
                            />
                          }
                          @default {
                              <input
                              type="text"
                              [formControlName]="i"
                              placeholder="Enter {{ metadata.title }}"
                              [ngClass]="{
                                'border-red-500':
                                  form.get(metadata.metadata_registry_id.toString())?.invalid &&
                                  form.get(metadata.metadata_registry_id.toString())?.touched,
                                'border-gray-300':
                                  !(form.get(metadata.metadata_registry_id.toString())?.invalid &&
                                    form.get(metadata.metadata_registry_id.toString())?.touched)
                              }"
                              class="flex-1 rounded-lg border bg-transparent py-2.5 px-4 text-sm dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"
                            />
                          }
                        }
                        @if(form.get(metadata.metadata_registry_id.toString())?.touched &&
                        form.get(metadata.metadata_registry_id.toString())?.hasError('invalidDate')){
                          <div class="text-sm text-red-500 ml-1 error-styling">
                            Invalid date format
                          </div>
                        }

                        <div class="flex items-center gap-2">
                          @if (i === getFormArray(metadata.metadata_registry_id).length - 1) {
                            <button
                              title="Add Value"
                              type="button"
                              (click)="addMore(metadata)"
                              class="px-3 py-2 text-sm text-brand-600 border rounded-lg hover:bg-brand-50 dark:hover:bg-brand-900/20 dark:border-gray-700 dark:bg-gray-900">
                              <i class="fa-solid fa-plus text-primary"></i>
                            </button>
                          }

                          @if ((getFormArray(metadata.metadata_registry_id).length > 1) && (i !== getFormArray(metadata.metadata_registry_id).length - 1)) {
                            <button
                              title="Remove Value"
                              type="button"
                              (click)="removeAt(metadata, i)"
                              class="px-3 py-2 rounded-lg text-red-600 border hover:bg-red-50 dark:hover:bg-red-900/20"
                              title="Remove">
                              <i class="fas fa-trash text-danger"></i>
                            </button>
                          }
                        </div>
                      </div>
                    }
                  </div>
                  }
                } @else {
                  @switch (metadata.componentType?.name?.toLowerCase()) {
                    @case ('text') {
                      <input
                        type="text"
                        [formControlName]="metadata.metadata_registry_id"
                        placeholder="Enter {{ metadata.title }}"
                        [ngClass]="{
                          'border-red-500':
                            form.get(metadata.metadata_registry_id.toString())?.invalid &&
                            form.get(metadata.metadata_registry_id.toString())?.touched,
                          'border-gray-300':
                            !(form.get(metadata.metadata_registry_id.toString())?.invalid &&
                              form.get(metadata.metadata_registry_id.toString())?.touched)
                        }"
                        class="w-full rounded-lg border bg-transparent py-2.5 px-4 text-sm dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"
                      />
                    }
                    @case ('number') {
                      <input
                        type="number"
                        min="1"
                        [formControlName]="metadata.metadata_registry_id"
                        placeholder="Enter {{ metadata.title }}"
                        [ngClass]="{
                          'border-red-500':
                            form.get(metadata.metadata_registry_id.toString())?.invalid &&
                            form.get(metadata.metadata_registry_id.toString())?.touched,
                          'border-gray-300':
                            !(form.get(metadata.metadata_registry_id.toString())?.invalid &&
                              form.get(metadata.metadata_registry_id.toString())?.touched)
                        }"
                        class="w-full rounded-lg border bg-transparent py-2.5 px-4 text-sm dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"
                      />
                    }
                    @case ('dropdown') {
                      <select
                        [formControlName]="metadata.metadata_registry_id"
                        [ngClass]="{
                          'border-red-500':
                            form.get(metadata.metadata_registry_id.toString())?.invalid &&
                            form.get(metadata.metadata_registry_id.toString())?.touched,
                          'border-gray-300':
                            !(form.get(metadata.metadata_registry_id.toString())?.invalid &&
                              form.get(metadata.metadata_registry_id.toString())?.touched)
                        }"
                      class="h-11 w-full rounded-lg border bg-transparent
                            px-3.5 py-2.5 pr-11 text-sm shadow-theme-xs
                            border-gray-300 focus:border-brand-300 focus:outline-hidden
                            focus:ring-3 focus:ring-brand-500/10
                            dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"
                      >
                        <option [ngValue]="null">
                          Select {{ metadata.title }}
                        </option>

                        @for (option of getOptionsFromId(metadata.dropdown?.dropdown_id); track $index) {
                          <option [ngValue]="option.value">
                            {{ option.label }}
                          </option>
                        }
                      </select>
                    }
                    <!-- <input
                      type="text"
                      [formControlName]="metadata.metadata_registry_id"
                      placeholder="DD-MM-YYYY"
                      [ngClass]="{
                        'border-red-500':
                          form.get(metadata.metadata_registry_id.toString())?.invalid &&
                          form.get(metadata.metadata_registry_id.toString())?.touched,
                        'border-gray-300':
                          !(form.get(metadata.metadata_registry_id.toString())?.invalid &&
                            form.get(metadata.metadata_registry_id.toString())?.touched)
                      }"
                      class="w-full rounded-lg border bg-transparent py-2.5 px-4 text-sm dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"
                      (input)="formatDateInput($event, metadata.metadata_registry_id.toString())"
                    /> -->
                    @case ('date') {
                      <app-date-picker
                        id="date-picker-single"
                        placeholder="Select a date"
                        (dateChange)="handleDateChange($event,metadata.metadata_registry_id)"
                        class="w-full rounded-lg bg-transparent text-sm dark:bg-gray-900 dark:text-white/90"
                        [ngClass]="{
                          'border-red-500':
                            form.get(metadata.metadata_registry_id.toString())?.invalid &&
                            form.get(metadata.metadata_registry_id.toString())?.touched,
                          'border-gray-300':
                            !(form.get(metadata.metadata_registry_id.toString())?.invalid &&
                              form.get(metadata.metadata_registry_id.toString())?.touched)
                        }"
                      />
                    }@default {
                      <input
                        type="text"
                        [formControlName]="metadata.metadata_registry_id"
                        placeholder="Enter {{ metadata.title }}"
                        [ngClass]="{
                          'border-red-500':
                            form.get(metadata.metadata_registry_id.toString())?.invalid &&
                            form.get(metadata.metadata_registry_id.toString())?.touched,
                          'border-gray-300':
                            !(form.get(metadata.metadata_registry_id.toString())?.invalid &&
                              form.get(metadata.metadata_registry_id.toString())?.touched)
                        }"
                        class="w-full rounded-lg border bg-transparent py-2.5 px-4 text-sm  dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"
                      />
                    }
                  }
                }
                @if(form.get(metadata.metadata_registry_id.toString())?.touched &&
                  form.get(metadata.metadata_registry_id.toString())?.hasError('invalidDate')){
                      <div class="text-sm text-red-500 ml-1 error-styling">
                        Invalid date format
                      </div>
                  }
              </div>
            }
          </div>
        }
      </div>
    }
    <div class="">
      <button
        [disabled]="form.invalid"
        [ngClass]="{'btn-disabled': form.invalid}"
        type="submit"
        class="rounded-lg bg-brand-600 px-6 py-2.5 text-sm text-white transition-all duration-200 ease-in-out shadow-sm hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0 active:shadow-md focus:outline-none focus:ring-2 focus:ring-brand-500/40  disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-none disabled:hover:translate-y-0 disabled:active:shadow-none">
        Submit
      </button>
    </div>
  </form>
</div>

<!-- ITEMS LIST -->
<div class="mt-8">
  <div class="p-4 rounded-lg border bg-gray-50 dark:bg-gray-800 dark:border-gray-700">
    <div class="flex items-center justify-between">
      <h3 class="mb-2 text-lg font-semibold text-gray-800 dark:text-gray-200">
        List of Files
      </h3>
    </div>
  
    <!-- Empty State -->
    @if (items && items.length === 0) {
      <div class="text-sm text-gray-500 dark:text-gray-400 italic">
        No items added yet.
      </div>
    }

    <div class="space-y-3">
      @for (item of items; track item.item_id) {
        <div
          class="flex items-center justify-between p-4 rounded-lg border bg-white
                 dark:bg-gray-800 dark:border-gray-700
                 hover:shadow-sm transition">
          <!-- Item Info -->
          <div class="flex flex-col">
            <span class="font-medium text-gray-800 dark:text-gray-200">
              {{ item.name }}
            </span>
            @if(isDevMode){
              <span class="text-xs text-gray-500 dark:text-gray-400">
                ID: {{ item.item_id }}
              </span>  
            } 
          </div>

          <!-- Actions -->
          <div class="flex items-center gap-2">
            <!-- Edit -->
            <button
              type="button"
              (click)="editItem(item)"
              class="p-2 rounded-lg border border-gray-300
                     hover:bg-brand-50 text-brand-600
                     dark:border-gray-600 dark:hover:bg-brand-900/20"
              title="Edit"
            >
              <i class="fas fa-edit"></i>
            </button>

            <!-- Delete -->
            <button
              type="button"
              (click)="deleteItem(item)"
              class="p-2 rounded-lg border border-red-300
                     hover:bg-red-50 text-red-600
                     dark:border-red-600 dark:hover:bg-red-900/20"
              title="Delete"
            >
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Items Container -->
  @if (items && items.length) {
    <!-- Batch Delivery Date Section -->
    <div class="mt-6 p-4 rounded-lg border bg-gray-50 dark:bg-gray-800 dark:border-gray-700">
      <div class="space-y-4">
        <div class="flex flex-col">
          <label class="mb-2 text-lg font-semibold text-gray-800 dark:text-gray-200">
            Batch Related Actions
          </label>
          <app-date-picker 
            (dateChange)="handleDeliveryDateChange($event)"
            placeholder="Select batch delivery date"
            class="w-full">
          </app-date-picker>
        </div>

        <div class="flex justify-end">
          <app-button 
            [variant]="'primary'" 
            [size]="'md'"
            (btnClick)="commitBatch()"
            [disabled]="!items || items.length === 0">
            <i class="fas fa-check mr-2"></i>
            Commit Batch
          </app-button>
        </div>
      </div>
    </div>
  }
</div>


<!-- Delete Confirmation Modal -->
<app-modal 
    [isOpen]="isDeleteModalOpen" 
    (close)="isDeleteModalOpen = false"
    [showCloseButton]="true"
    className="max-w-md">
    <div class="p-6">
        <h2 class="mb-4 text-xl font-semibold text-gray-800 dark:text-white/90">
            Delete File
        </h2>
        
        <p class="mb-6 text-gray-700 dark:text-gray-400">
            Are you sure you want to delete this file?
            @if (selectedItemToDelete) {
                <strong class="block mt-2 text-gray-900 dark:text-white">{{ selectedItemToDelete.name }}</strong>
            }
        </p>
        
        <div class="flex justify-end gap-3">
            <app-button 
                [variant]="'outline'" 
                [size]="'md'"
                (btnClick)="isDeleteModalOpen = false">
                Cancel
            </app-button>
            <app-button 
                [variant]="'primary'" 
                [size]="'md'"
                (btnClick)="confirmDelete()"
                class="bg-red-500 hover:bg-red-600">
                <i class="fas fa-trash mr-2"></i>
                Yes, Delete
            </app-button>
        </div>
    </div>
</app-modal>